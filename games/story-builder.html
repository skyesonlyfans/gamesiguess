import React, { useState, useEffect, useRef } from 'react';
import { Tv, Users, Share2, Settings, Home, Plus, ThumbsUp, Clock, Book, Sparkles } from 'lucide-react';

const StoryBuilder = () => {
  const [mode, setMode] = useState('menu');
  const [displayMode, setDisplayMode] = useState(false);
  const [roomCode, setRoomCode] = useState('');
  const [playerName, setPlayerName] = useState('');
  const [genre, setGenre] = useState('fantasy');
  const [story, setStory] = useState([]);
  const [currentPrompts, setCurrentPrompts] = useState([]);
  const [myPrompt, setMyPrompt] = useState('');
  const [hasSubmitted, setHasSubmitted] = useState(false);
  const [votingPhase, setVotingPhase] = useState(false);
  const [myVote, setMyVote] = useState(null);
  const [timer, setTimer] = useState(60);
  const [players, setPlayers] = useState([]);
  const [gamePhase, setGamePhase] = useState('waiting');
  const [showQR, setShowQR] = useState(false);
  const [isHost, setIsHost] = useState(false);

  const genres = [
    { id: 'fantasy', name: 'âš”ï¸ Fantasy', starter: 'In a realm where magic flows like rivers...' },
    { id: 'scifi', name: 'ðŸš€ Sci-Fi', starter: 'The year is 2247, and humanity has just discovered...' },
    { id: 'mystery', name: 'ðŸ” Mystery', starter: 'The detective arrived at the mansion as thunder rumbled overhead...' },
    { id: 'romance', name: 'ðŸ’• Romance', starter: 'Their eyes met across the crowded cafÃ©, and time seemed to stop...' },
    { id: 'horror', name: 'ðŸ‘» Horror', starter: 'The old house on the hill had been abandoned for decades, until tonight...' },
    { id: 'comedy', name: 'ðŸ˜‚ Comedy', starter: 'It was a perfectly normal day, until the chicken learned to fly...' }
  ];

  useEffect(() => {
    const loadData = async () => {
      if (roomCode) {
        try {
          const storyData = await window.storage.get(`story:${roomCode}`, true);
          const promptsData = await window.storage.get(`prompts:${roomCode}`, true);
          const playersData = await window.storage.get(`players:${roomCode}`, true);
          const phaseData = await window.storage.get(`phase:${roomCode}`, true);
          
          if (storyData) setStory(JSON.parse(storyData.value));
          if (promptsData) setCurrentPrompts(JSON.parse(promptsData.value));
          if (playersData) setPlayers(JSON.parse(playersData.value));
          if (phaseData) {
            const phase = JSON.parse(phaseData.value);
            setGamePhase(phase.state);
            setVotingPhase(phase.state === 'voting');
          }
        } catch (e) {
          console.log('New room');
        }
      }
    };
    
    if (mode === 'game' && roomCode) {
      loadData();
      const interval = setInterval(loadData, 2000);
      return () => clearInterval(interval);
    }
  }, [mode, roomCode]);

  useEffect(() => {
    if (votingPhase && timer > 0) {
      const interval = setInterval(() => setTimer(t => Math.max(0, t - 1)), 1000);
      return () => clearInterval(interval);
    }
    if (timer === 0 && votingPhase) {
      endVoting();
    }
  }, [votingPhase, timer]);

  const generateRoomCode = () => {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
  };

  const createRoom = async () => {
    const code = generateRoomCode();
    setRoomCode(code);
    const selectedGenre = genres.find(g => g.id === genre);
    const initialStory = [{ text: selectedGenre.starter, author: 'Story', votes: 0 }];
    
    await window.storage.set(`story:${code}`, JSON.stringify(initialStory), true);
    await window.storage.set(`players:${code}`, JSON.stringify([{ name: playerName, id: Date.now() }]), true);
    await window.storage.set(`phase:${code}`, JSON.stringify({ state: 'writing', round: 1 }), true);
    await window.storage.set(`genre:${code}`, genre, true);
    
    setStory(initialStory);
    setPlayers([{ name: playerName, id: Date.now() }]);
    setGamePhase('writing');
    setMode('game');
  };

  const joinRoom = async () => {
    try {
      const storyData = await window.storage.get(`story:${roomCode}`, true);
      if (storyData) {
        const playersData = await window.storage.get(`players:${roomCode}`, true);
        const currentPlayers = playersData ? JSON.parse(playersData.value) : [];
        const newPlayer = { name: playerName, id: Date.now() };
        currentPlayers.push(newPlayer);
        
        await window.storage.set(`players:${roomCode}`, JSON.stringify(currentPlayers), true);
        setPlayers(currentPlayers);
        setMode('game');
      }
    } catch (e) {
      alert('Room not found!');
    }
  };

  const submitPrompt = async () => {
    if (myPrompt.trim() && !hasSubmitted) {
      const promptsData = await window.storage.get(`prompts:${roomCode}`, true);
      const currentPrompts = promptsData ? JSON.parse(promptsData.value) : [];
      currentPrompts.push({ text: myPrompt, author: playerName, votes: 0, id: Date.now() });
      
      await window.storage.set(`prompts:${roomCode}`, JSON.stringify(currentPrompts), true);
      setCurrentPrompts(currentPrompts);
      setHasSubmitted(true);
      setMyPrompt('');
      
      if (currentPrompts.length >= Math.max(2, players.length)) {
        await window.storage.set(`phase:${roomCode}`, JSON.stringify({ state: 'voting', round: story.length }), true);
        setVotingPhase(true);
        setGamePhase('voting');
        setTimer(60);
      }
    }
  };

  const vote = async (promptId) => {
    if (!myVote) {
      setMyVote(promptId);
      const promptsData = await window.storage.get(`prompts:${roomCode}`, true);
      const prompts = JSON.parse(promptsData.value);
      const prompt = prompts.find(p => p.id === promptId);
      if (prompt) {
        prompt.votes = (prompt.votes || 0) + 1;
        await window.storage.set(`prompts:${roomCode}`, JSON.stringify(prompts), true);
        setCurrentPrompts(prompts);
      }
    }
  };

  const endVoting = async () => {
    const winner = [...currentPrompts].sort((a, b) => (b.votes || 0) - (a.votes || 0))[0];
    if (winner) {
      const storyData = await window.storage.get(`story:${roomCode}`, true);
      const currentStory = JSON.parse(storyData.value);
      currentStory.push(winner);
      
      await window.storage.set(`story:${roomCode}`, JSON.stringify(currentStory), true);
      await window.storage.set(`prompts:${roomCode}`, JSON.stringify([]), true);
      await window.storage.set(`phase:${roomCode}`, JSON.stringify({ state: 'writing', round: currentStory.length }), true);
      
      setStory(currentStory);
      setCurrentPrompts([]);
      setVotingPhase(false);
      setGamePhase('writing');
      setHasSubmitted(false);
      setMyVote(null);
      setTimer(60);
    }
  };

  const saveStory = () => {
    const text = story.map(s => s.text).join(' ');
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `story-${roomCode}.txt`;
    a.click();
  };

  const getQRCode = () => {
    const url = window.location.href.split('?')[0] + '?room=' + roomCode;
    return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}`;
  };

  if (displayMode) {
    return (
      <div style={{ background: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)', minHeight: '100vh', color: 'white', padding: '40px' }}>
        <div style={{ maxWidth: '1400px', margin: '0 auto' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '40px' }}>
            <h1 style={{ fontSize: '3rem', fontWeight: '800' }}>ðŸ“– Story Builder</h1>
            <button onClick={() => setDisplayMode(false)} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', padding: '12px 24px', borderRadius: '12px', color: 'white', cursor: 'pointer', fontSize: '1rem' }}>
              Exit TV Mode
            </button>
          </div>

          <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: '20px', padding: '40px', marginBottom: '30px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '30px' }}>
              <div>
                <div style={{ fontSize: '1.2rem', opacity: 0.7 }}>Room Code</div>
                <div style={{ fontSize: '2.5rem', fontWeight: '800', color: '#4ecdc4' }}>{roomCode}</div>
              </div>
              <div>
                <div style={{ fontSize: '1.2rem', opacity: 0.7 }}>Players</div>
                <div style={{ fontSize: '2.5rem', fontWeight: '800' }}>{players.length} <Users size={32} style={{ display: 'inline', verticalAlign: 'middle' }} /></div>
              </div>
              <div>
                <div style={{ fontSize: '1.2rem', opacity: 0.7 }}>Phase</div>
                <div style={{ fontSize: '2.5rem', fontWeight: '800', color: votingPhase ? '#ff6b6b' : '#4ecdc4' }}>
                  {votingPhase ? 'VOTING' : 'WRITING'}
                </div>
              </div>
            </div>
          </div>

          <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: '20px', padding: '40px', marginBottom: '30px' }}>
            <h2 style={{ fontSize: '2rem', marginBottom: '30px', display: 'flex', alignItems: 'center', gap: '10px' }}>
              <Book size={32} /> The Story So Far
            </h2>
            <div style={{ fontSize: '1.5rem', lineHeight: '2', opacity: 0.9 }}>
              {story.map((s, i) => (
                <span key={i} style={{ marginRight: '8px' }}>
                  {s.text}
                  {i < story.length - 1 && ' '}
                </span>
              ))}
            </div>
          </div>

          {votingPhase && currentPrompts.length > 0 && (
            <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: '20px', padding: '40px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px' }}>
                <h2 style={{ fontSize: '2rem', display: 'flex', alignItems: 'center', gap: '10px' }}>
                  <ThumbsUp size={32} /> Vote for Next Sentence
                </h2>
                <div style={{ fontSize: '2rem', color: '#ff6b6b', fontWeight: '800' }}>
                  <Clock size={32} style={{ display: 'inline', verticalAlign: 'middle' }} /> {timer}s
                </div>
              </div>
              <div style={{ display: 'grid', gap: '20px' }}>
                {currentPrompts.map((p, i) => (
                  <div key={i} style={{ background: 'rgba(255,255,255,0.1)', borderRadius: '15px', padding: '30px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <div style={{ fontSize: '1.5rem', marginBottom: '10px' }}>{p.text}</div>
                      <div style={{ fontSize: '1rem', opacity: 0.6 }}>by {p.author}</div>
                    </div>
                    <div style={{ fontSize: '3rem', fontWeight: '800', color: '#4ecdc4' }}>{p.votes || 0} votes</div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  if (mode === 'menu') {
    return (
      <div style={{ background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
        <div style={{ maxWidth: '600px', width: '100%' }}>
          <div style={{ textAlign: 'center', marginBottom: '40px' }}>
            <button onClick={() => window.location.href = '/'} style={{ background: 'rgba(255,255,255,0.2)', border: 'none', padding: '10px 20px', borderRadius: '10px', color: 'white', cursor: 'pointer', marginBottom: '20px' }}>
              <Home size={20} style={{ verticalAlign: 'middle' }} /> Back to Games
            </button>
            <h1 style={{ fontSize: '3rem', color: 'white', fontWeight: '800', marginBottom: '10px' }}>ðŸ“– Story Builder</h1>
            <p style={{ color: 'rgba(255,255,255,0.9)', fontSize: '1.2rem' }}>Create stories together, one sentence at a time</p>
          </div>

          <div style={{ background: 'white', borderRadius: '20px', padding: '40px', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }}>
            <input
              type="text"
              placeholder="Your name"
              value={playerName}
              onChange={(e) => setPlayerName(e.target.value)}
              style={{ width: '100%', padding: '15px', borderRadius: '10px', border: '2px solid #e0e0e0', fontSize: '1rem', marginBottom: '20px' }}
            />

            <div style={{ marginBottom: '30px' }}>
              <label style={{ display: 'block', marginBottom: '10px', fontWeight: '600', color: '#333' }}>Choose Genre</label>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px' }}>
                {genres.map(g => (
                  <button
                    key={g.id}
                    onClick={() => setGenre(g.id)}
                    style={{ padding: '15px', borderRadius: '10px', border: genre === g.id ? '3px solid #667eea' : '2px solid #e0e0e0', background: genre === g.id ? 'rgba(102,126,234,0.1)' : 'white', cursor: 'pointer', fontSize: '1rem', fontWeight: '600' }}
                  >
                    {g.name}
                  </button>
                ))}
              </div>
            </div>

            <button
              onClick={createRoom}
              disabled={!playerName}
              style={{ width: '100%', padding: '18px', borderRadius: '12px', border: 'none', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', fontSize: '1.2rem', fontWeight: '700', cursor: playerName ? 'pointer' : 'not-allowed', opacity: playerName ? 1 : 0.5, marginBottom: '15px' }}
            >
              <Plus size={24} style={{ verticalAlign: 'middle', marginRight: '8px' }} />
              Create New Story
            </button>

            <div style={{ textAlign: 'center', margin: '20px 0', color: '#999' }}>or</div>

            <input
              type="text"
              placeholder="Room code"
              value={roomCode}
              onChange={(e) => setRoomCode(e.target.value.toUpperCase())}
              style={{ width: '100%', padding: '15px', borderRadius: '10px', border: '2px solid #e0e0e0', fontSize: '1rem', marginBottom: '15px', textTransform: 'uppercase' }}
            />

            <button
              onClick={joinRoom}
              disabled={!playerName || !roomCode}
              style={{ width: '100%', padding: '18px', borderRadius: '12px', border: 'none', background: '#4ecdc4', color: 'white', fontSize: '1.2rem', fontWeight: '700', cursor: (playerName && roomCode) ? 'pointer' : 'not-allowed', opacity: (playerName && roomCode) ? 1 : 0.5 }}
            >
              Join Story
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div style={{ background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', minHeight: '100vh', padding: '20px' }}>
      <div style={{ maxWidth: '900px', margin: '0 auto' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
          <button onClick={() => setMode('menu')} style={{ background: 'rgba(255,255,255,0.2)', border: 'none', padding: '10px 20px', borderRadius: '10px', color: 'white', cursor: 'pointer' }}>
            <Home size={20} style={{ verticalAlign: 'middle' }} /> Exit
          </button>
          <div style={{ display: 'flex', gap: '10px' }}>
            <button onClick={() => setShowQR(!showQR)} style={{ background: 'rgba(255,255,255,0.2)', border: 'none', padding: '10px 20px', borderRadius: '10px', color: 'white', cursor: 'pointer' }}>
              <Share2 size={20} style={{ verticalAlign: 'middle' }} /> QR
            </button>
            <button onClick={() => setDisplayMode(true)} style={{ background: 'rgba(255,255,255,0.2)', border: 'none', padding: '10px 20px', borderRadius: '10px', color: 'white', cursor: 'pointer' }}>
              <Tv size={20} style={{ verticalAlign: 'middle' }} /> TV Mode
            </button>
            <button onClick={saveStory} style={{ background: 'rgba(255,255,255,0.2)', border: 'none', padding: '10px 20px', borderRadius: '10px', color: 'white', cursor: 'pointer' }}>
              Save Story
            </button>
          </div>
        </div>

        {showQR && (
          <div style={{ background: 'white', borderRadius: '20px', padding: '30px', marginBottom: '20px', textAlign: 'center' }}>
            <h3 style={{ marginBottom: '20px' }}>Scan to Join</h3>
            <img src={getQRCode()} alt="QR Code" style={{ maxWidth: '300px' }} />
            <div style={{ marginTop: '20px', fontSize: '1.5rem', fontWeight: '800', color: '#667eea' }}>{roomCode}</div>
          </div>
        )}

        <div style={{ background: 'white', borderRadius: '20px', padding: '30px', marginBottom: '20px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '20px' }}>
            <div>
              <div style={{ fontSize: '0.9rem', color: '#999' }}>Room Code</div>
              <div style={{ fontSize: '1.5rem', fontWeight: '800', color: '#667eea' }}>{roomCode}</div>
            </div>
            <div>
              <div style={{ fontSize: '0.9rem', color: '#999' }}>Players</div>
              <div style={{ fontSize: '1.5rem', fontWeight: '800' }}><Users size={24} style={{ verticalAlign: 'middle' }} /> {players.length}</div>
            </div>
          </div>
          <div style={{ fontSize: '0.9rem', color: '#999', marginBottom: '5px' }}>Players: {players.map(p => p.name).join(', ')}</div>
        </div>

        <div style={{ background: 'white', borderRadius: '20px', padding: '30px', marginBottom: '20px' }}>
          <h2 style={{ marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '10px' }}>
            <Book size={28} /> The Story
          </h2>
          <div style={{ fontSize: '1.1rem', lineHeight: '1.8', color: '#333' }}>
            {story.map((s, i) => (
              <span key={i} style={{ marginRight: '5px' }}>
                {s.text}
                {i < story.length - 1 && ' '}
              </span>
            ))}
          </div>
        </div>

        {!votingPhase && !hasSubmitted && (
          <div style={{ background: 'white', borderRadius: '20px', padding: '30px' }}>
            <h3 style={{ marginBottom: '15px' }}>Add Your Sentence</h3>
            <textarea
              value={myPrompt}
              onChange={(e) => setMyPrompt(e.target.value)}
              placeholder="Write the next sentence..."
              style={{ width: '100%', padding: '15px', borderRadius: '10px', border: '2px solid #e0e0e0', fontSize: '1rem', minHeight: '100px', resize: 'vertical', marginBottom: '15px' }}
            />
            <button
              onClick={submitPrompt}
              disabled={!myPrompt.trim()}
              style={{ width: '100%', padding: '15px', borderRadius: '10px', border: 'none', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', fontSize: '1.1rem', fontWeight: '700', cursor: myPrompt.trim() ? 'pointer' : 'not-allowed', opacity: myPrompt.trim() ? 1 : 0.5 }}
            >
              Submit Sentence
            </button>
          </div>
        )}

        {!votingPhase && hasSubmitted && (
          <div style={{ background: 'white', borderRadius: '20px', padding: '30px', textAlign: 'center' }}>
            <Sparkles size={48} style={{ color: '#4ecdc4', marginBottom: '15px' }} />
            <h3>Sentence Submitted!</h3>
            <p style={{ color: '#666', marginTop: '10px' }}>Waiting for other players...</p>
          </div>
        )}

        {votingPhase && (
          <div style={{ background: 'white', borderRadius: '20px', padding: '30px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h3>Vote for Next Sentence</h3>
              <div style={{ fontSize: '1.5rem', fontWeight: '800', color: '#ff6b6b' }}>
                <Clock size={24} style={{ verticalAlign: 'middle' }} /> {timer}s
              </div>
            </div>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
              {currentPrompts.map((p, i) => (
                <div
                  key={i}
                  onClick={() => vote(p.id)}
                  style={{ padding: '20px', borderRadius: '10px', border: myVote === p.id ? '3px solid #4ecdc4' : '2px solid #e0e0e0', background: myVote === p.id ? 'rgba(78,205,196,0.1)' : 'white', cursor: myVote ? 'default' : 'pointer', transition: 'all 0.3s' }}
                >
                  <div style={{ marginBottom: '10px', fontSize: '1.1rem' }}>{p.text}</div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.9rem', color: '#666' }}>
                    <span>by {p.author}</span>
                    <span><ThumbsUp size={16} style={{ verticalAlign: 'middle' }} /> {p.votes || 0} votes</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default StoryBuilder;
